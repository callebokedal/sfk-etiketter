<!doctype html>
<html>
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
	<meta name="referrer" content="strict-origin">
    <title>Excel till etiketter</title>
	<link href="lib/bootstrap-5.0.1/css/bootstrap.min.css" rel="stylesheet">
	<link href="lib/css/style.css" rel="stylesheet">
	<link rel="icon" href="lib/img/favicon.svg">
	<link rel="apple-touch-icon" href="lib/img/favicon.ico">
    <script src="lib/js/jquery-3.6.0.min.js"></script>
    <script src="lib/js/lodash.min.js"></script>
    <script src="lib/js/xlsx.full.min.js"></script>
</head>
<body>

	<nav class="navbar navbar-dark shadow-sm no-print">
		<div class="container">
			<a class="navbar-brand" href="#">
			<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="#fff" class="bi bi-grid-3x3-gap-fill" viewBox="0 0 16 16">
				<path d="M1 2a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V2zm5 0a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1H7a1 1 0 0 1-1-1V2zm5 0a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1h-2a1 1 0 0 1-1-1V2zM1 7a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V7zm5 0a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1H7a1 1 0 0 1-1-1V7zm5 0a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1h-2a1 1 0 0 1-1-1V7zM1 12a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1v-2zm5 0a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1H7a1 1 0 0 1-1-1v-2zm5 0a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1h-2a1 1 0 0 1-1-1v-2z"/>
			</svg>
			Sjövalla FK - Etiketter
			</a>
		</div>
	</nav>

	<!-- Template for A4-page with 3x8 grids -->
	<script type="text/template" id="pageTemplate">
		<div class="row persons">
			<% 
			let idx = 0;
			_.forEach(persons, function(person) {
				if(idx == 24) {
					idx = 0; %>
				</div></div><div class="page-break"></div><div class="container-fluid"><div class="row persons">
				<% }
				%><div class="col col-4 mb-4 border fs-6 person">
					<div class="name" <%= person.family?'title="Familj: ' +person.family+'"':'' %>><%= person.name %><span class="d-none no-print"> <%= person.birthDate %></span></div>
					<div class="streetaddress"><%= person.streetaddress %></div>
					<div class="postaladdress"><%= person.postalcode %> <%= person.postaladdress %></div>
					<!--<div class="grupper"><%= person.grupper %></div>-->
				</div>
			<% idx++;
			}); %>
		</div>
	</script>

	<div class="container no-print">
		<h4 class="mt-3">Instruktioner</h4>
		<ul class="list-group mb-4">
			<li class="list-group-item">1. Exportera en Excel-fil med medlemmar från <a href="https://www.sjovalla.se" target="_blank">Idrott Online</a>
				<ul class="list-group mb-1">
					<li class="list-group-item">A. Logga in som vanligt</li>
					<li class="list-group-item">B. Gå till <span class="fw-bold">Administration</span> &raquo; <span class="fw-bold">Personer</span></li>
					<li class="list-group-item">C. Klicka på Sök (dvs. sök på alla medlemmar)</li>
					<li class="list-group-item">D. Välj <span class="fw-bold">Exportera</span> &raquo; <span class="fw-bold">Exportera till Excel</span></li>
					<li class="list-group-item">E. Välj <span class="fw-bold">Exportera med födelsedatum</span> samt <span class="fw-bold">Exkludera målsman</span></li>
					<li class="list-group-item">F. Klicka <span class="fw-bold">Exportera</span></li>
				</ul>
			</li>
			<li class="list-group-item">2. Spara Excel-filen på din dator</li>
			<li class="list-group-item">3. Gå till denna sida och läs in Excel-filen:
				<form class="row g-3 my-1">
					<div class="col-auto">
						<input class="form-control" type="file" id="formFile" accept=".xls,.xlsx,.xlsb">
					</div>
					<div class="col-auto">
						<button type="submit" class="btn btn-primary mb-3" onclick="upload();return false;">Läs in fil</button>
						<!--<button type="submit" class="btn btn-primary mb-3" onclick="print();return false;">Skriv ut...</button>-->
					</div>
				</form>
			</li>
			<li class="list-group-item">4. Välj "Skriv ut" i webbläsaren</li>
		</ul>

	</div>
	<div class="container-fluid">
		<div id="pageBody"></div>
	</div>

    <script>
		'use strict';

		/*document.addEventListener("DOMContentLoaded", function(event) { 
			console.log("Ready!");
		});*/

		// Fill page with list of persons
		let fillPage = (list) => {
			// Template
			let pageTemplate = _.template($('#pageTemplate').html());

			// Render
			$("#pageBody").html(pageTemplate({persons:list}));
		}

		// Use print method, to get elements right
		/*let print = () => {

		};*/

		let upload = () => {
			//Reference the FileUpload element.
			let fileUpload = document.getElementById("formFile");
			console.log("file: ", fileUpload.value);
	
			// Validate whether File is valid Excel file.
			let regex = /^([a-zA-Z0-9\s_\\.-:]).+(.xls|.xlsx|.xlsb)$/;
			if (regex.test(fileUpload.value.toLowerCase())) {
				if (typeof (FileReader) != "undefined") {
					let reader = new FileReader();
					//For Browsers other than IE.
					if (reader.readAsBinaryString) {
						reader.onload = function (e) {
							processExcel(e.target.result);
						};
						reader.readAsBinaryString(fileUpload.files[0]);
					} else {
						//For IE Browser.
						reader.onload = function (e) {
							var data = "";
							var bytes = new Uint8Array(e.target.result);
							for (var i = 0; i < bytes.byteLength; i++) {
								data += String.fromCharCode(bytes[i]);
							}
							processExcel(data);
						};
						reader.readAsArrayBuffer(fileUpload.files[0]);
					}
				} else {
					alert("Den här webbläsaren har inte stöd för HTML5 - vilket är ett krav");
				}
			} else {
				alert("Vald fil är ogiltig!");
			}
		};

		let processExcel = (data) => {
			console.log("processExcel");
			//Read the Excel File data.
			let workbook = XLSX.read(data, {
				type: 'binary'
			});
	
			//Fetch the name of First Sheet.
			let firstSheet = workbook.SheetNames[0];
	
			//Read all rows from First Sheet into an JSON array.
			let excelRows = XLSX.utils.sheet_to_row_object_array(workbook.Sheets[firstSheet]);
			
			// For testing purposes, to limit the result in "size"
			let i=0;

			let result = [];
			for (let person of excelRows) {
				if(i<5000) {
					i++;
					result.push(_.pick(person, ['Förnamn', 'Efternamn',
						'Folkbokföring - Gatuadress',
						'Folkbokföring - Postnummer',
						'Folkbokföring - Postort',
						'Folkbokföring - c/o adress',
						'Familj',
						'Kontaktadress - Gatuadress',
						'Kontaktadress - Postnummer',
						'Kontaktadress - Postort',
						'Kontaktadress - c/o adress',
						'Födelsedat./Personnr.',
						'Grupp/Lag/Arbetsrum/Familj'
					]));
				}
			}
			// Rename/convert properties
			result = result.map((e) => {
				if(_.trim(e['Folkbokföring - Gatuadress']) != "") {
					// Assume we have Folkbokföringsadress
					return {
						name: e['Förnamn'] + ' ' + e['Efternamn'],
						streetaddress: e['Folkbokföring - Gatuadress'],
						postalcode: e['Folkbokföring - Postnummer'],
						postaladdress: e['Folkbokföring - Postort'],
						co_address: e['Folkbokföring - c/o adress'],
						family: e['Familj'],
						birthDate: e['Födelsedat./Personnr.'],
						grupper: e['Grupp/Lag/Arbetsrum/Familj']
					}
				} else {
					// Fallback to Kontaktadress
					return {
						name: e['Förnamn'] + ' ' + e['Efternamn'],
						streetaddress: e['Kontaktadress - Gatuadress'],
						postalcode: e['Kontaktadress - Postnummer'],
						postaladdress: e['Kontaktadress - Postort'],
						co_address: e['Kontaktadress - c/o adress'],
						family: e['Familj'],
						birthDate: e['Födelsedat./Personnr.'],
						grupper: e['Grupp/Lag/Arbetsrum/Familj']
					}
				}
			});

			// Perhaps reject some?
			// result = _.reject(result, function(o) { return !o.active; });

			// Reject persons with MC_IngenTidning
			result = _.reject(result, function(o) {
				return _.map(_.split(o.grupper, ','), _.trim).includes('MC_IngenTidning');
			});

			// Keep only one per family
			let familyList = []; // Keep track of existing families
			result = _.sortBy(result, [function(o) { return o.birthDate; }]); // To get oldest person as family representant
			result = _.filter(result, function(person) {
				if(person.family) {
					if(!familyList.includes(person.family)) {
						familyList.push(person.family); // Store as family representant
						return true;
					} 
					return false; // Skip if amyliy member already stored (should be older due to sorting)
				} 
				return true; 
			});

			// Sort by postnummer - by request
			result = _.sortBy(result, [function(o) { return o.postalcode; }]);
			
			fillPage(result);
		};
    </script>
</body>
</html>